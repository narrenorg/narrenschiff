---
- name: Init helm
  helm:
    command: init
    opts:
      - tiller-tls
      - tiller-tls-verify
    args:
      tiller-tls-cert: "{{ tiller_cert_pem | secretmap }}"
      tiller-tls-key: "{{ tiller_key_pem | secretmap }}"
      tls-ca-cert: "{{ ca_cert_pem | secretmap }}"
      service-account: tiller
      tiller-namespace: kube-system

- name: Update repo
  helm:
    command: repo update

- name: Install a chart
  helm:
    command: install
    chart: charts/pypiserver
    opts:
      - tls
      - atomic
    args:
      tls-ca-cert: "{{ ca_cert_pem | secretmap }}"
      tls-cert: "{{ helm_cert_pem | secretmap }}"
      tls-key: "{{ helm_key_pem | secretmap }}"
      version: "0.1.0"
      namespace: "development"
      name: "pypiserver"
      set:
        - "secret.htpasswd='admin:1ce4cee4e1a24b9b9babb8e01f9752ae'"
        - "common.storage='5'"
